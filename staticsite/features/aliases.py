from __future__ import annotations

import logging
from typing import TYPE_CHECKING

from staticsite import fields, metadata, structure
from staticsite.feature import Feature
from staticsite.page import Page

if TYPE_CHECKING:
    from staticsite.site import Site

log = logging.getLogger("aliases")


class AliasesPageMixin(metaclass=metadata.FieldsMetaclass):
    aliases = fields.Field(structure=True, doc="""
        Relative paths in the destination directory where the page should also show up.
        [Like in Hugo](https://gohugo.io/extras/aliases/), this can be used to maintain
        existing links when moving a page to a different location.
    """)


class AliasesFeature(Feature):
    """
    Build redirection pages for page aliases.

    A page can define 'aliases=[...]' to generate pages in those locations that
    redirect to the page.
    """
    RUN_AFTER = ["autogenerated_pages"]

    def __init__(self, *args, **kw):
        super().__init__(*args, **kw)
        self.site.features["rst"].yaml_tags.add("aliases")
        self.page_mixins.append(AliasesPageMixin)
        self.site.structure.add_tracked_metadata("aliases")

    def analyze(self):
        # Build alias pages from pages with an 'aliases' metadata
        for page in self.site.structure.pages_by_metadata["aliases"]:
            aliases = page.meta.get("aliases")
            if not aliases:
                continue

            for alias in aliases:
                self.site.structure.root.create_page(
                        page_cls=AliasPage,
                        created_from=page,
                        alias=alias,
                        meta_values={"page": page},
                        path=structure.Path.from_string(alias))


class AliasPage(Page):
    """
    Page rendering a redirect to another page
    """
    page = fields.Field(doc="Page this alias redirects to")
    TYPE = "alias"
    # Default template to use for this type of page
    TEMPLATE: str

    def __init__(self, site: Site, *, alias: str, **kw):
        super().__init__(site, **kw)
        self.meta["template"] = "redirect.html"


FEATURES = {
    "aliases": AliasesFeature,
}
